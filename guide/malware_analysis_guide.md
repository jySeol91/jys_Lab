# 멀웨어 분석 환경 구축 가이드

## 목차
- [개요](#개요)
- [PC 한 대로 안전한 분석 환경 구축](#pc-한-대로-안전한-분석-환경-구축)
- [안티-VM 회피 기법](#안티-vm-회피-기법)
- [고급 분석 환경](#고급-분석-환경)
- [보안 수칙](#보안-수칙)

## 개요

이 가이드는 PC 한 대에서 일반 사용과 멀웨어 분석을 안전하게 분리하여 수행할 수 있는 환경 구축 방법을 제공합니다. 최신 멀웨어의 안티-VM 기법까지 고려한 실용적인 솔루션을 다룹니다.

## PC 한 대로 안전한 분석 환경 구축

### 1. 가상머신 기반 완전 격리

#### VMware Workstation Pro / VirtualBox 설정
```
호스트 OS (일반 사용) ─ 인터넷 연결
    │
    └── 분석 VM ─ Host-Only 네트워크 (완전 격리)
```

#### 안전한 VM 설정 방법

**VMware 설정**
- 네트워크 어댑터: "Host-only" 또는 "Internal" 선택
- 공유 폴더: 완전 비활성화
- 클립보드 공유: 비활성화
- 드래그 앤 드롭: 비활성화

**VirtualBox 설정**
- 네트워크: "Internal Network" 또는 "Host-only Adapter"
- 공유 클립보드: "비활성화"
- 공유 폴더: 설정하지 않음
- USB 컨트롤러: 비활성화

### 3. 안전한 샘플 전송

#### ISO 방식 전송 (권장)
```bash
# 1. 호스트에서 격리된 폴더 생성
mkdir /tmp/malware_samples
chmod 700 /tmp/malware_samples

# 2. 샘플을 ISO 이미지로 생성
# Linux/macOS
mkisofs -o sample.iso /path/to/sample/

# Windows (ImgBurn 등 사용)
```

#### 전송 절차
1. 분석할 파일을 ISO 이미지로 생성
2. VM에서 ISO를 CD/DVD로 마운트
3. 분석 완료 후 ISO 언마운트 및 삭제

### 6. 네트워크 시뮬레이션

#### INetSim 설정 (Linux VM)
```bash
# 설치
sudo apt-get install inetsim

# 실행
sudo inetsim --config=/etc/inetsim/inetsim.conf
```

#### FakeNet-NG (Windows VM)
```powershell
# 설치 후 실행
python fakenet.py
```

## 안티-VM 회피 기법

### 1. 주요 탐지 기법들

#### 하드웨어 기반 탐지
- VM 특유의 하드웨어 시그니처
- MAC 주소 패턴 (VMware: 00:50:56, VirtualBox: 08:00:27)
- CPU 브랜드 문자열 검사
- 메모리/디스크 용량 확인

#### 소프트웨어 기반 탐지
- VM 관련 프로세스/서비스 탐지
- 레지스트리 키 확인
- 파일시스템 아티팩트 검사
- VM 도구 설치 여부 확인

### 2. VM 환경 위장

#### VMware 설정 수정
VM 설정 파일(.vmx) 편집:
```vmx
isolation.tools.getPtrLocation.disable = "TRUE"
isolation.tools.setPtrLocation.disable = "TRUE"
isolation.tools.setVersion.disable = "TRUE"
isolation.tools.getVersion.disable = "TRUE"
monitor_control.restrict_backdoor = "TRUE"
hypervisor.cpuid.v0 = "FALSE"

# 하드웨어 정보 위장
hw.model = "Dell Inc. OptiPlex 7090"
```

#### VirtualBox 설정 수정
```bash
# VM 정보 변경
VBoxManage setextradata "VM이름" "VBoxInternal/Devices/VMMDev/0/Config/GetHostTimeDisabled" 1
VBoxManage setextradata "VM이름" "VBoxInternal/Devices/pcbios/0/Config/DmiBIOSVendor" "Award Software International"
VBoxManage setextradata "VM이름" "VBoxInternal/Devices/pcbios/0/Config/DmiSystemVendor" "ASUS"
```

#### MAC 주소 변경
```bash
# 실제 하드웨어 벤더 MAC 주소 사용
# Intel: 00:13:02:xx:xx:xx
# Dell: 00:14:22:xx:xx:xx
# HP: 00:17:08:xx:xx:xx

VBoxManage modifyvm "VM이름" --macaddress1 "001302123456"
```

### 3. 레지스트리 및 파일시스템 위장

#### VMware 흔적 제거
```powershell
# 레지스트리 정리
Remove-ItemProperty -Path "HKLM:\HARDWARE\DESCRIPTION\System" -Name "SystemBiosVersion" -ErrorAction SilentlyContinue
Set-ItemProperty -Path "HKLM:\HARDWARE\DESCRIPTION\System" -Name "VideoBiosVersion" -Value "NVIDIA GeForce RTX 3080"

# 서비스 정리
Stop-Service -Name "VMTools" -ErrorAction SilentlyContinue
sc.exe delete "VMTools"
```

#### 파일시스템 정리
```batch
# VM 관련 파일 삭제
del /f /q "C:\Program Files\VMware\*"
del /f /q "C:\Windows\System32\drivers\vm*"
del /f /q "C:\Windows\System32\vm*"
rmdir /s /q "C:\Program Files\VMware"
```

### 4. 프로세스 및 활동 시뮬레이션

#### 가짜 사용자 활동 생성
```python
import time
import random
import subprocess

def simulate_user_activity():
    """사용자 활동 시뮬레이션"""
    # 브라우저 실행
    subprocess.Popen(['chrome.exe', '--no-sandbox'], 
                    creationflags=subprocess.CREATE_NO_WINDOW)
    
    # 오피스 프로그램 실행
    subprocess.Popen(['notepad.exe'], 
                    creationflags=subprocess.CREATE_NO_WINDOW)
    
    # 랜덤 대기
    time.sleep(random.uniform(30, 120))

def create_fake_network_activity():
    """가짜 네트워크 활동"""
    domains = ['google.com', 'microsoft.com', 'github.com']
    for domain in domains:
        subprocess.run(['ping', '-n', '1', domain], 
                      capture_output=True)
```

#### 시스템 부하 시뮬레이션
```powershell
# CPU 사용률 조정
$cpu = Get-WmiObject -Class Win32_Processor
$load = Get-Random -Minimum 20 -Maximum 60
# 적절한 시스템 부하 유지
```

## 고급 분석 환경

### 2. 하드웨어 정보 완전 위장

#### CPU 정보 변경
```bash
# QEMU에서 실제 CPU처럼 보이게 설정
-cpu Haswell-v4,+rdrand,+rdseed,-hypervisor,-vmx,-ept
```

#### 메모리 및 디스크 설정
- 실제 PC 수준의 메모리 할당 (8GB 이상)
- 대용량 가상 디스크 생성 (500GB 이상)
- 실제 사용된 것처럼 더미 파일로 디스크 채우기

### 3. 네트워크 환경 고도화

#### 실제 네트워크 시뮬레이션
```bash
# 백그라운드 네트워크 활동
while true; do
    curl -s http://google.com > /dev/null &
    ping -c 1 8.8.8.8 > /dev/null &
    sleep $(shuf -i 10-60 -n 1)
done
```

#### DNS 및 서비스 시뮬레이션
```python
# 가짜 DNS 서버
import socket
import threading

def dns_server():
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.bind(('0.0.0.0', 53))
    
    while True:
        data, addr = sock.recvfrom(1024)
        # DNS 응답 시뮬레이션
        response = create_dns_response(data)
        sock.sendto(response, addr)
```

## 보안 수칙

### 1. 호스트 시스템 보호

#### 필수 보안 설정
- 실시간 바이러스 검사 활성화
- VM 폴더 제외하고 전체 스캔 실행
- Windows Defender / 백신 소프트웨어 최신 상태 유지
- 정기적인 시스템 백업

#### 격리 확인 체크리스트
- [ ] VM 네트워크 어댑터가 Host-only로 설정됨
- [ ] VM 공유 폴더 비활성화됨
- [ ] VM 클립보드 공유 비활성화됨
- [ ] VM USB 패스스루 비활성화됨
- [ ] 호스트 방화벽 활성화됨

### 2. 분석 중 주의사항

#### 절대 금지 사항
- VM에서 호스트로 파일 복사
- 네트워크 공유 폴더 사용
- USB 드라이브 VM에 연결
- VM 도구 설치 (Guest Additions/Tools)

#### 권장 사항
- 분석 전후 스냅샷 비교
- 모든 활동 스크린샷으로 기록
- 중요한 발견사항은 즉시 문서화
- 의심스러운 네트워크 활동 모니터링

---

**⚠️ 경고**: 이 가이드는 교육 및 연구 목적으로만 사용되어야 합니다. 악의적인 목적으로 사용하는 것은 법적 처벌을 받을 수 있습니다.

**📝 라이선스**: MIT License

**🤝 기여**: 이슈나 풀 리퀘스트를 통해 개선사항을 제안해 주세요.